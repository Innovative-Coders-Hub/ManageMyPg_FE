import{f as ee,u as z,r as c,j as e,k as se,l as te,m as re}from"./index-DZruhiV_.js";import{P as oe}from"./PageHeader-D4m0aPrs.js";import{d as A}from"./dayjs.min-7h3eaHmg.js";function ae({bed:d,context:l}){const p=z(),g=A(),N=d.occupied===!0;let u=N?"occupied":"available";if(N&&d.endDate){const h=A(d.endDate);h.isValid()&&h.diff(g,"day")<=7&&(u="vacating")}const m={available:"border-green-300 bg-green-50 hover:bg-green-100",occupied:"border-red-300 bg-red-50 hover:bg-red-100",vacating:"border-amber-300 bg-amber-50 hover:bg-amber-100"},i=()=>{p(`/beds/${encodeURIComponent(d.id)}`,{state:{bedName:d.name}})};return e.jsxs("button",{onClick:i,className:`relative w-20 h-20 rounded-xl border transition shadow-sm ${m[u]}`,title:d.tenant?d.tenant.name:"Available",children:[e.jsx("div",{className:`absolute top-0 left-0 right-0 h-1 rounded-t-xl ${u==="available"?"bg-green-500":u==="vacating"?"bg-amber-500":"bg-red-500"}`}),e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx("div",{className:"text-lg font-bold text-gray-800",children:d.name}),e.jsx("div",{className:"text-[10px] text-gray-600 mt-1 text-center px-1 truncate",children:d.tenant?d.tenant.name:"Vacant"})]})]})}function ne({floorNumber:d,setFloorNumber:l,addFloor:p,filters:g,setFilters:N}){const u=[{key:"ac",label:"AC",on:"bg-sky-100 border-sky-300 text-sky-800",off:"bg-white border-sky-200 text-sky-700 hover:bg-sky-50"},{key:"nonac",label:"Non-AC",on:"bg-red-100 border-red-300 text-red-800",off:"bg-white border-red-200 text-red-700 hover:bg-red-50"},{key:"available",label:"Available",on:"bg-green-100 border-green-300 text-green-800",off:"bg-white border-green-200 text-green-700 hover:bg-green-50"},{key:"vacatingSoon",label:"Vacating ≤ 7d",on:"bg-amber-100 border-amber-300 text-amber-800",off:"bg-white border-amber-200 text-amber-700 hover:bg-amber-50"}];return e.jsx("div",{className:"z-40",children:e.jsx("div",{className:"flex flex-col gap-3",children:e.jsxs("div",{className:"w-full rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-gray-800 text-sm",children:"Filters"}),e.jsx("button",{type:"button",className:"px-2 py-1 rounded-lg bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-700",onClick:()=>N({ac:!1,nonac:!1,available:!1,vacatingSoon:!1}),"aria-label":"Clear filters",children:"Clear"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:u.map(m=>e.jsx("button",{type:"button",onClick:()=>N(i=>({...i,[m.key]:!i[m.key]})),className:`inline-flex items-center gap-1 px-3 py-1 rounded-full border text-sm transition ${g[m.key]?m.on:m.off}`,"aria-pressed":!!g[m.key],children:m.label},m.key))})]})})})}function ce(){const{id:d}=ee();z();const[l,p]=c.useState(null),[g,N]=c.useState(null),[u,m]=c.useState(null),[i,h]=c.useState({number:"",sharing:2,ac:!1,beds:[]}),[I,R]=c.useState({id:""}),[v,f]=c.useState(""),[w,O]=c.useState({ac:!1,nonac:!1,available:!1,vacatingSoon:!1}),[U,V]=c.useState({}),[C,P]=c.useState(""),[G,y]=c.useState(!1),[_,B]=c.useState(!1),[b,j]=c.useState({name:"",roomCount:0,rooms:[]}),[q,$]=c.useState(!1),M=s=>{const t=Number(s);!Number.isFinite(t)||t<=0||j(r=>({...r,roomCount:t,rooms:Array.from({length:t},(o,a)=>({name:`Room ${a+1}`,sharing:2,ac:!1,beds:[]}))}))},k=()=>{j({name:"",roomCount:0,rooms:[]}),$(!1),f("")},E=(s=[])=>s.map(t=>({id:t.id,number:String(t.floorName).trim(),rooms:(t.roomsResponses||[]).map(r=>({id:r.id,number:r.roomName,sharing:r.sharing,ac:String(r.roomType).toUpperCase().includes("AC")&&!String(r.roomType).toUpperCase().includes("NON"),beds:(r.bedResponseList||[]).map(o=>({id:o.id,name:o.bedName,occupied:o.occupied,endDate:o.endDate||null,tenant:null}))}))})),H=()=>b?!!(b.name||b.roomCount>0||(b.rooms||[]).length>0):!1;c.useEffect(()=>{async function s(){try{const t=await re(d),r=E(t);p(o=>({...o,id:d,floors:r}))}catch(t){console.error(t),p(null)}}d&&s()},[d]);const K=s=>{s.preventDefault(),C?.trim()&&(p(t=>!t||(t.floors||[]).some(r=>String(r.number)===String(C).trim())?t:{...t,floors:[...t.floors||[],{number:String(C).trim(),rooms:[]}]}),P(""))},L=s=>{const{ac:t,nonac:r}=w;return!!(!t&&!r||t&&s.ac||r&&!s.ac)},W=s=>{const{available:t,vacatingSoon:r}=w;if(!t&&!r)return s.beds||[];const o=A();return(s.beds||[]).filter(a=>{const n=!a.occupied;let x=!1;if(a.occupied&&a.endDate){const F=A(a.endDate);x=F.isValid()&&F.diff(o,"day")<=7}return t&&n||r&&x})},T=c.useMemo(()=>l?(l.floors||[]).map(s=>{const t=(s.rooms||[]).filter(L).map(r=>({...r,beds:W(r)}));return{...s,rooms:t}}):[],[l,w]),Y=l?.floors?.reduce((s,t)=>s+(t.rooms||[]).reduce((r,o)=>r+(o.beds?.length||0),0),0)||0,J=l?.floors?.reduce((s,t)=>s+(t.rooms||[]).reduce((r,o)=>r+(o.beds||[]).filter(a=>!!a.tenant).length,0),0)||0,Q=()=>{if(!l)return[];const s=[];return(l.floors||[]).forEach(t=>{(t.rooms||[]).forEach(r=>{(r.beds||[]).forEach(o=>{o.tenant&&o.tenant.name&&s.push({name:o.tenant.name,floor:t.number,room:r.number,bedId:o.id})})})}),s};c.useMemo(()=>Q(),[l]);const X=(s,t)=>{p(r=>{if(!r)return r;const o=(r.floors||[]).map(x=>({...x})),a=o.findIndex(x=>x.number===s);if(a===-1)return r;const n=[...o[a].rooms||[],t];return o[a]={...o[a],rooms:n},{...r,floors:o}})},Z=l?.floors?.reduce((s,t)=>s+(t.rooms?.length||0),0)||0;if(!l)return e.jsxs("div",{className:"max-w-6xl px-4 py-6",children:[e.jsx("div",{className:"mb-4",children:e.jsx(oe,{title:"PG not found",showBack:!0})}),e.jsxs("div",{className:"text-gray-600",children:["We couldn’t find a PG with id “",d,"”."]})]});const D=l?.pgName||"PG";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:flex-nowrap items-stretch gap-6",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"rounded-2xl border bg-white p-4 shadow-sm h-full flex flex-col lg:flex-row lg:items-center lg:gap-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-lg bg-gradient-to-br from-indigo-100 to-blue-100 flex items-center justify-center text-indigo-700 font-semibold text-lg",children:D.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-gray-800 truncate",title:D,children:D}),e.jsx("div",{className:"text-xs text-gray-600 mt-0.5 truncate",children:typeof l.address=="string"?l.address:l.address?.address||""})]})]}),e.jsxs("div",{className:"flex flex-wrap lg:flex-nowrap gap-3 lg:mt-0 mt-6",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-gray-50 border text-center min-w-[72px]",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Floors"}),e.jsx("div",{className:"font-semibold text-gray-800",children:l.floors?.length||0})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-gray-50 border text-center min-w-[72px]",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Rooms"}),e.jsx("div",{className:"font-semibold text-gray-800",children:Z})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-gray-50 border text-center min-w-[72px]",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Beds"}),e.jsx("div",{className:"font-semibold text-gray-800",children:Y})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-gray-50 border text-center min-w-[72px]",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Occupied"}),e.jsx("div",{className:"font-semibold text-gray-800",children:J})]})]}),e.jsx("div",{className:"flex-shrink-0 w-full sm:w-auto lg:ml-auto mt-4 lg:mt-0",children:e.jsxs("div",{className:"rounded-lg border bg-gradient-to-r from-blue-50 to-indigo-50 p-2",children:[e.jsx("div",{className:"flex items-center justify-between mb-0"}),e.jsx("button",{type:"button",onClick:()=>y(!0),className:"px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700",children:"Add Floor"})]})})]})}),e.jsx("div",{className:"w-full md:w-96 flex-shrink-0",children:e.jsx(ne,{floorNumber:C,setFloorNumber:P,addFloor:K,filters:w,setFilters:O})})]}),T.length===0?e.jsx("div",{className:"flex items-center justify-center min-h-[40vh]",children:e.jsx("div",{className:"px-6 py-4 rounded-xl border bg-yellow-50 text-yellow-800 text-sm font-medium shadow-sm",children:"No rooms or beds are available, Please start by adding rooms and beds."})}):e.jsx("div",{className:"space-y-6",children:T.map(s=>{const t=String(s.number),r=U[t]??!0,o=s.rooms.reduce((n,x)=>n+(x.beds?.length||0),0),a=s.rooms.length;return e.jsxs("div",{className:"rounded-2xl border bg-white p-4 shadow-sm overflow-hidden",children:[e.jsx("div",{className:"w-full flex items-center justify-between gap-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>V(n=>({...n,[t]:!r})),className:"h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-100 to-blue-100 border flex items-center justify-center text-indigo-700 font-semibold","aria-expanded":r,children:s.number}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold",children:s.number}),e.jsxs("div",{className:"text-xs text-gray-600",children:[a," room",a!==1?"s":""," • ",o," bed",o!==1?"s":""," visible"]})]})]})}),r&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:s.rooms.map(n=>{const x=(n.beds||[]).length,F=(n.beds||[]).filter(S=>!!S.tenant).length;return e.jsxs("div",{className:"rounded-xl border p-2 bg-gradient-to-br from-gray-50 to-white hover:shadow transition w-full",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium",children:["Room ",n.number]}),e.jsxs("div",{className:"text-[12px] text-gray-500 mt-0.5",children:["• ",n.sharing,"-sharing"]}),e.jsxs("div",{className:"text-[11px] text-gray-400",children:[F,"/",x," occupied"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded ${n.ac?"bg-sky-50 border border-sky-200 text-sky-700":"bg-red-50 border border-red-200 text-red-700"}`,children:e.jsx("span",{className:"text-xs font-medium",children:n.ac?"AC":"Non-AC"})}),e.jsx("button",{className:"text-xs px-2 py-1 rounded border bg-white font-medium",onClick:()=>m({floorId:s.id,roomId:n.id,floorNumber:s.number,roomNumber:n.number}),children:"Add Bed"})]})]}),e.jsx("div",{className:"mt-3 flex flex-wrap gap-3 justify-start",children:(n.beds||[]).length>0?n.beds.map(S=>e.jsx("div",{className:"flex-none",children:e.jsx(ae,{bed:S,context:{pgId:l.id,floor:s.number,room:n.number}})},`${s.number}-${n.number}-${String(S.id)}`)):e.jsx("div",{className:"text-xs text-gray-400 italic",children:"No beds added yet"})})]},n.number)})})})]},s.number)})}),G&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsx("div",{className:"w-full max-w-lg rounded-2xl bg-white p-4 shadow-lg",children:q?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-green-600 font-semibold text-lg",children:"Floor created successfully ✅"}),e.jsx("div",{className:"text-sm text-gray-500 mt-2",children:"This window will close automatically."}),e.jsx("button",{className:"mt-4 px-3 py-2 rounded border",onClick:()=>{k(),y(!1)},children:"Close now"})]}):_?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-yellow-600 font-semibold text-lg",children:"Unsaved changes ⚠️"}),e.jsx("div",{className:"text-sm text-gray-600 mt-2",children:"You have unsaved changes. Do you want to discard them?"}),e.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded border text-sm",onClick:()=>B(!1),children:"Continue Editing"}),e.jsx("button",{className:"px-4 py-2 rounded bg-red-600 text-white text-sm hover:bg-red-700",onClick:()=>{k(),B(!1),y(!1)},children:"Discard Changes"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4 -mx-4 px-4 py-2 bg-gradient-to-r from-indigo-50 to-blue-50 border-b text-center",children:e.jsx("h3",{className:"font-semibold text-gray-800",children:"Create Floor"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:"Floor Name"}),e.jsx("input",{placeholder:"Floor name / number",value:b.name,onChange:s=>j(t=>({...t,name:s.target.value})),className:"w-full px-3 py-2 rounded border"}),e.jsx("h4",{className:"font-semibold text-gray-800",children:"Rooms"}),e.jsx("input",{type:"number",placeholder:"Number of rooms",value:b.roomCount||"",onChange:s=>M(s.target.value),className:"w-full px-3 py-2 rounded border"}),b.rooms.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 w-14",children:"Room Name"}),e.jsx("input",{placeholder:"Name",value:s.name,onChange:r=>{const o=[...b.rooms];o[t].name=r.target.value,j(a=>({...a,rooms:o}))},className:"flex-1 px-2 py-1 rounded border text-sm"}),e.jsx("div",{className:"text-xs font-medium text-gray-600 w-14",children:"Sharing"}),e.jsx("input",{type:"number",min:1,value:s.sharing,onChange:r=>{const o=[...b.rooms];o[t].sharing=Number(r.target.value),j(a=>({...a,rooms:o}))},className:"w-20 px-2 py-1 rounded border text-sm"}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:s.ac,onChange:r=>{const o=[...b.rooms];o[t].ac=r.target.checked,j(a=>({...a,rooms:o}))}}),"AC"]})]}))]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded border",onClick:()=>{H()?B(!0):(k(),y(!1))},children:"Cancel"}),e.jsx("button",{className:"px-3 py-2 rounded bg-indigo-600 text-white",onClick:async()=>{try{const s={pgId:d,floorName:b.name.trim(),roomsSize:b.rooms.length,roomsRequests:b.rooms.map(o=>({roomName:o.name,roomType:o.ac?"AC":"NON AC",sharing:o.sharing,beds:o.sharing}))},t=await se(s),r=E([t])[0];p(o=>({...o,floors:[...o.floors||[],r]})),$(!0),setTimeout(()=>{k(),y(!1)},2e3)}catch(s){console.error(s),f(s?.response?.data?.message||"Failed to save floor. Please try again.")}},children:"Save Floor"})]})]})})}),g&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl bg-white p-4 shadow-lg",children:[e.jsxs("h3",{className:"font-semibold mb-3",children:["Add Room to Floor ",g.floor]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{value:i.number,onChange:s=>h(t=>({...t,number:s.target.value})),placeholder:"Room number",className:"w-full px-3 py-2 rounded border"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",value:i.sharing,onChange:s=>h(t=>({...t,sharing:Number(s.target.value)})),className:"w-24 px-3 py-2 rounded border"}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:i.ac,onChange:s=>h(t=>({...t,ac:s.target.checked}))})," AC"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Beds in this room"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[(i.beds||[]).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between gap-2 border rounded px-2 py-1",children:[e.jsxs("div",{className:"text-sm",children:[s.id," ",s.occupied?` • ${s.tenant?.name}`:""]}),e.jsx("div",{className:"text-xs text-red-600 cursor-pointer",onClick:()=>h(r=>({...r,beds:r.beds.filter((o,a)=>a!==t)})),children:"Remove"})]},t)),e.jsx("div",{children:e.jsx("button",{className:"px-3 py-2 rounded border text-sm",onClick:()=>m({floor:g.floor,roomNumber:i.number||"new",onSave:s=>h(t=>({...t,beds:[...t.beds||[],s]}))}),children:"Add Bed"})})]})]}),v&&e.jsx("div",{className:"text-sm text-red-600",children:v}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded border",onClick:()=>{N(null),h({number:"",sharing:2,ac:!1,beds:[]}),f("")},children:"Cancel"}),e.jsx("button",{className:"px-3 py-2 rounded bg-indigo-600 text-white",onClick:()=>{if(!i.number){f("Enter room number");return}const s=(l.floors||[]).find(r=>r.number===g.floor);if(!s){f("Floor not found");return}if((s.rooms||[]).some(r=>String(r.number)===String(i.number))){f("Room number already exists on this floor");return}const t=Array.from({length:i.sharing},(r,o)=>({id:`tmp-${Date.now()}-${o}`,name:`B${o+1}`,tenant:null}));X(g.floor,{number:i.number,sharing:i.sharing,ac:i.ac,beds:t}),N(null),h({number:"",sharing:2,ac:!1,beds:[]})},children:"Save Room"})]})]})]})}),u&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl bg-white p-4 shadow-lg",children:[e.jsxs("h3",{className:"font-semibold mb-3",children:["Add Bed • ",u.floorNumber," • Room ",u.roomNumber]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs text-gray-600",children:"Bed Name"}),e.jsx("input",{value:I.id,onChange:s=>R(t=>({...t,id:s.target.value})),placeholder:"e.g. B1",className:"w-full px-3 py-2 rounded border"}),v&&e.jsx("div",{className:"text-sm text-red-600",children:v}),e.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[e.jsx("button",{className:"px-3 py-2 rounded border",onClick:()=>{m(null),R({id:""}),f("")},children:"Cancel"}),e.jsx("button",{className:"px-3 py-2 rounded bg-indigo-600 text-white",onClick:async()=>{try{const s=I.id?.trim();if(!s){f("Bed name is required");return}const t={bedName:s,roomId:u.roomId,floorId:u.floorId,pgId:l.id},r=await te(t);p(o=>{const a=o.floors.map(n=>n.id!==u.floorId?n:{...n,rooms:n.rooms.map(x=>x.id!==u.roomId?x:{...x,beds:[...x.beds||[],{id:r.id,name:r.bedName,tenant:null}]})});return{...o,floors:a}}),m(null),R({id:""}),f("")}catch(s){console.error(s),f(s?.response?.data?.message||"Failed to add bed")}},children:"Save Bed"})]})]})]})})]})}export{ce as default};
